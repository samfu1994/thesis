%# -*- coding: utf-8-unix -*-
%%==================================================
%% chapter03.tex for SJTU Master Thesis
%%==================================================

%\bibliographystyle{sjtu2}%[此处用于每章都生产参考文献]
\chapter{数据预处理}
\label{chap:chap3}

\section{脑电信号数据预处理流程}
	在本论文中，在进行多模态深度学习之前，需要先将提取到的脑电原始数据进行预处理，而从原始数据转化到我们的输入数据需要经过三个步骤：消除噪声去除伪迹，特征提取和特征平滑。详细流程图请见下图:\\
	由于脑电十分微弱($\mu$V级)，采集EEG信号过程中受到的干扰非常多，因此我们拿到的原始数据并不是纯粹的脑电数据，而在其中夹杂了很多噪音。为了解决这个问题，我们应该首先对原始数据进行合适的预处理，在保留有用的EEG信号的前提下，删除掉夹杂着的噪音信号。另外，由于同一个视频片段的情绪应该是一定的，不会出现突然由令人高兴到令人悲伤的跌宕起伏的情节，所以情绪的变化理应稳定平滑，不应该出现剧烈的改变。因此我们认为EEG信号的剧烈变化是由于非情绪相关的大脑其他活动引起的，譬如回忆。所以，我们同样有必要对数据进行平滑处理，这样就可以消除脑电信号的剧烈抖动，增加信号的稳定性和数据的可信度。
\section{消除噪声和去伪迹}
	由于上述原因，我们总结出了以下几种干扰，都是由非情绪相关的大脑活动产生的。
	\begin{itemize}
	\item 眼电伪迹：大脑发出控制眼球的指令就会产生电流，从而形成这种与情绪无关的脑电信号，对于我们的原始数据而言，它是需要去除的噪声。频率为1-50Hz.
	\item 肌电伪迹：由于人不可能保持完全静止的状态，所以肌肉的运动会产生脑电信号，对比于反应情绪的微弱脑电信号，肌电信号可以达到相当大，产生很大程度的污染，大大影响我们提出的数据。
	\item 心电伪迹：心跳的过程也会产生电场和脑电信号，作为我们数据的噪声，频率大约在1Hz。
	\item 皮电干扰：由于人的排汗和空气湿度变化，涂抹在脑电电极周围的脑电膏会产生一定程度的浓度改变等，影响脑电信号的稳定性，从而产生了噪声。
	\end{itemize}
	
	我们首先对原始数据进行降采样，采样率为200Hz。另外，由于1-50Hz的脑电信号是具有明确生理意义的，所以我们才去原始数据以后先进行滤波，提取出1-75Hz的信号，这一步即可消除大部分噪声。

\section{脑电特征提取}
	原始数据经过降采样之后依旧是在时域上，为了保持与之前实验室成果的对比，以及利用EEG信号在频域上的生理意义，本论文采用EEG的频域特征作为输入特征，并分析其与情绪的关系。
	\subsection{时域到频域的特征变换}
		在这个步骤中，离散短时傅立叶变换(Short-Term Fourier Transform, 简称为STFT)是常用并且快速有效的方法。
		
		如果我们设$x[n] = {x_1,…, x_n}$为某一电极上，每个时间窗采集到的原始数据样本数。那么我们就可以利用STFT算法得到下式：
		\begin{align}
		STFT{X[n]}(m, \omega_{k}) \heartsuit X(m, \omega_{k}) = \sum_{n = 1}^N x[n]w[n-m]e^{-j\omega_k n}
		\end{align}
		
	其中，k为整数，并且定义区间是[0,N), $\omega_k = \frac{2\pi k}{N}$,并且w是一个窗口函数，它的作用是对每一个窗口独立地进行傅立叶变换，当我们把整个信号按照时序分成很多片段然后每个片段分别进行傅立叶变换，那么就得到了每个窗口所代表时间的频域信号。这样既得到了频域信息，又没有在整个时域直接进行变换，从而保留了部分时序性，减少了原始信号的时间方面的信息丢失，也为之后对循环神经网络等需要时间信息输入的研究提供了数据。
	
	汉宁窗是常见的窗口函数，也是本论文所使用的。定义如下：
	\begin{align}
	 w[n]=\left\{
	\begin{aligned}
	x & = 0.5[1-\cos(\frac{2\pi n}{M - 1})] ,  & 1 \leq n < M\\
	0 &, & otherwise \\
	\end{aligned}
	\right.
	\end{align}
	
	经过多次试验和测试，我们决定采用窗口大小为4秒的汉宁窗函数。
	
	现在的研究有充分的证据证明，1-50Hz频段的脑电信号有明确生理意义，它被更细的划分为代表1-4Hz的Delta频段， 4-8Hz的Theta频段，8-13Hz的Alpha频段，13-30Hz的beta频段和30-50Hz的Gamma频段。我们首先利用傅立叶变换得到每个频段的信号，然后再利用傅立叶变换计算的到每个频段的能谱：
	\begin{align}
	E(\omega_k) = X(m, \omega_k) * X^*(m, \omega_k)
	\end{align}
	其中*代表的是共轭函数的意思。
	
	经过傅立叶变换和后续计算以后，我们得到的EEG信号有62个频道，而每个频道可以分成5个更细的频段，所以我们最终的特征就是310维的向量，也就是我们深度学习网络的输入向量。
	\subsection{微分熵特征}
	微分熵(英文Differential Entropy，简称DE)由香农熵拓展而来，它描述随机变量的熵。
	设随机变量X，则X的概率密度函数$p(x)$的支持为集合C.那么它的微分熵$h(X)$可以由下式表示：
	\begin{align}
	h(X) = -\int_C f(x)logf(x)dx
	\end{align}
	自然地，我们可以用高斯分布来作为脑电信号的分布的假设，如此便可获得脑电信号离散序列的微分熵如下：
	\begin{align}
	h(X) &=  -\int_{\infty}^{-\infty} {\frac{1}{\sqrt{2\pi \sigma^2}} e^{\frac{{(x-\mu)}^2}{2\sigma^2}}log(\frac{1}{\sqrt{2\pi \sigma^2}}e^{\frac{{(x-\mu)}^2}{2\sigma^2}})dx} \\
	&=\frac{log(2\pi e \sigma^2)}{2}
	\end{align}
	通过对式(3-6)的分析，我们可以看出EEG信号的DE特征只与$\sigma^2$有关，同时，在去除了平均值以后，我们可以通过下式得出EEG信号的方差：
	\begin{align}
	\sigma^2 = \frac{1}{N} \sum_{i=1}^{N}{{x_i}^2}
	\end{align}
	根据式(3-7)我们可以看出方差$\sigma^2$与能量$P_i$是正比关系，因此再根据式(3-6)可得下式：
	\begin{align}
	h_i(X) = \frac{1}{2}log(2\pi e \sigma_i^2) = \frac{1}{2}log P_i + \frac{1}{2}log(\frac{2\pi e}{N})
	\end{align}
	经过进一步简化，我们可以得到下式：\\
	\begin{align}
	h_i(X) = log P_i
	\end{align}
	
	\section{特征平滑}
	经过上述预处理，此时的EEG信号已经排除了大部分噪声。可是正如本章开头所说，EEG信号除了包含与情绪相关的信息以外还包含很多其他活动带来的噪声，譬如肌肉的运动。所以，本文合理的假设人的情绪变化不会出现剧烈的波动，所有剧烈的变化都被认为是非情绪相关活动产生的噪声。下一步进行特征平滑，去除这个噪声，拿到更纯净的代表情绪活动的EEG数据。本文采取了滑动平均平滑方法喝线性动力系统平滑两种方法。
	\subsection{滑动平均平滑}
	以下是滑动平滑平均的基本假设：原始信号的离散序列不但包含了情绪相关的信号$x_n$，还包含了噪声信号$e_n$,可以用下式表示：
	\begin{align}
	y_n = x_n + e_n
	\end{align}
	根据我们的实验目的，我们应该尽力消除噪声信号，得到纯净的情绪相关的信号。滑动平滑平均是在一定的窗口时间区间内做平均。滑动平滑平均的思想非常简单，在一个时间区间内做平均可以明显降低这段时间内的信号波动，使得这段时间内的离散信号更加平缓，连续。具体计算方法如下式子：
	\begin{align}
	x_n = \frac{1}{2n + 1} \sum_{i=-n}^{i=n}y_{i+1}
	\end{align}
	
	\subsection{线性动力系统方法}
	由于滑动平滑平均方法需要选定一个长度作为求平均值的时间窗口的长度，所以对于远小于这个时间窗口的情绪波动效果一般没，而EEG信号的噪声譬如肌电噪声往往是很短时间内的波动。为了解决这个问题，我们找到了另一种特征平滑方法，线性动力系统(LDS)。LDS最大的优势在于它使用了概率模型预测了加权结果。
	
	假设原始EEG信号的离散序列为${z_1, z_2, …, y_n}$, 而情绪相关的脑电信号的离散序列是${x_1, x_2, …, x_n}$。我们假设后者开始总是服从正态分布:
	\begin{align}
	p(x_1) = \mathcal{N}(w|0, \sigma)
	\end{align}
	那么可以根据下式得到x和y，A为状态转移矩阵，C为观测矩阵，f,g,h均为服从正态分布的噪声:
	\begin{align*}
	x_n = Ax_{n-1} + w_n \\
	y_n = Cx_N + v_n\\
	x_1 = w_0 + u\\
	f = \mathcal{N}(f|0, \Gamma)\\
	g = \mathcal{N}{g|0, \Lambda}\\
	h = \mathcal{N}{h|0, \Sigma}\\
	\end{align*}
	
	那么可以得到下式作为x和y的正态分布的函数：
	\begin{align}
	p(x_n|x_{n-1}) = \mathcal{N}(x_n|Ax_{n-1}, \Gamma)\\
	p(y_n|x_n) = \mathcal{N}(Cx_n, \Lambda)
	\end{align}
	
	在已经知道${y_1, y_2, …, y_n}$的情况下，为了得到离散序列$x_n$,我们可以通过后验概率来计算：
	\begin{align}
	p(x_n|y_1, y_2, …, y_n) = \mathcal{N}(x_n|\mu_n, V_n)
	\end{align}
	正态分布的参数$\mu_n, V_n$可以通过下式迭代计算得到：
	\begin{align}
	P_{n-1} = AV_{n-1}A^T + \Gamma\\
	\mu_n = A\mu_n + K_n(y_n - CA\mu_{n-1})\\
	V_n = (1 - K_nC)P_{n-1}
	K_n = P_{n-1}C^T(CP_{n-1}C^T + \Sigma)^{-1}
	\end{align}
	此时，初始条件为:
	\begin{align}
	\mu_1 = K_1(y_1 - C\mu_0)\\
	V_1 = (I - K_1C)V_0\\
	K_1 = V_0C^T(CV_0C^T+\Sigma) ^ {-1}
	\end{align}
	
	为了完成LDS算法，我们需要以下参数集合:${A, C, \Gamma, \Sigma, V_0}$, 接下来利用EM(Expectation-Maximization)算法进行不断迭代最终求出LDS算法的最终解。
	\section{本章小结}
	本章介绍了如何将包含噪声的EEG原始信号去除噪声和伪迹，提取脑电特征，对特征进行平滑的两种方法等。最终提取出了适用于深度学习的EEG特征。
	